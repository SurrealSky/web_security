横向移动
================================

什么是内网横向攻击
--------------------------------
当通过外部打点进入到目标内网时，需要利用现有的资源尝试获取更多的凭证与权限，进而达到控制整个内网、拥有最高权限、发动 APT （高级持续性威胁攻击）等目地。
在攻防演练中，攻击方需要在有限的时间内近可能的获取更多的权限，因此必须具备高效的横向攻击思路。本次对内网横向攻击的技巧和方法进行总结。

注意事项
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 权限丢失
	webshell被发现，网站关站，木马后门被发现，主机改为不出网环境等。当遇到这些问题，需要做好应对措施，多方位的做好权限维持。
- 内网防火墙与杀毒软件
	内网防火墙，内网态势感知，内网流量监控，ids，ips等安全设备都会给横向攻击的开展造成很大的麻烦，应对措施有，对传输流量进行加密，修改cs流量特征，禁止大规模内网探测扫描等等。
- 内网蜜罐主机，蜜罐系统
	近年来攻防演练越来越多的防守方启用蜜罐主机，蜜罐系统，一旦蜜罐捕捉到攻击行为，并及时发现和处置，会导致权限丢失，前功尽弃。
- 运维管理人员
	内网横向攻击尽可能与运维管理人员的工作时间错开，尽量避免长时间登录administrator用户，如激活guest用户登录。降低被发现的几率。


windwos内网横穿
--------------------------------

常见端口
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ 445
	- MS17-010，永恒之蓝
	- 远程本地认证：``net use \\192.168.1.2 /user:a\username password``
	- 其中a为域或工作组下的机器命名
+ 137/138/139
	- NetBios端口，137，138为UDP端口，用于内网传输文件
	- NetBios/SMB服务获取通过139端口
+ 135
	- 使用DCOM和RPC服务，用于WMI管理工具的远程操作
+ 53
	- DNS域传送漏洞
	- DNS协议隐秘传输
+ 389
	- LDAP
+ 88
	- Kerberos服务，监听KDC的票据请求，用户黄金票据和白银票据的伪造
+ 5985
	WinRM服务

端口转发
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ portfwd
	- MSF自带工具
	- 将192.168.100.4的8888端口，映射到当前主机的8899端口
	- ``portfwd add -l 8899 -r 192.168.100.4 -p 8888``

代理工具
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ proxychains
	- 修改配置/etc/proxychains.conf
		::
		
			[ProxyList]
			socks5 172.20.0.59 7222
	- 直接在程序前增加proxychains
	- ``sudo proxychains apt-get update``
	- 注意：socks代理不支持UDP协议，不支持icmp/ping协议，nmap使用受限。

内网穿透
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ frp
	- 官网下载：https://github.com/fatedier/frp/releases
	- 示例
		::
		
			跳板机（假设IP为172.20.0.59/192.168.100.3双网卡）上frps.ini配置：
			[common]
			bind_port = 7111
			
			执行命令：frps.exe -c frps.ini
			
			目标机器（假设IP为192.168.100.4/128.0.0.2双网卡）上frpc.ini配置：
			[common]
			server_addr = 192.168.100.3
			server_port = 7111

			[plugin_1]
			type = tcp
			remote_port = 7222
			plugin = socks5
			
			执行命令：frpc.exe -c frpc.ini
			
			这样再kali里面设置proxychains代理/etc/proxychains.conf：
			[ProxyList]
			socks5 172.20.0.59 7222
			在172.20.0.1/24网段机器使用nmap直接对内网128网段进行扫描：
			proxychains nmap -sT -Pn -p- 128.0.0.1/24