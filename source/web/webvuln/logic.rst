逻辑漏洞 / 业务漏洞
================================

简介
--------------------------------
逻辑漏洞是指由于程序逻辑不严导致一些逻辑分支处理错误造成的漏洞。一般自动化漏洞扫描器是无法扫描出此类漏洞，只能通过手工的渗透测试去检查。

交易
--------------------------------

购买
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 修改支付的价格
	::
	
		（1）利用拦截发包协议修改支付价格。
		（2）四舍五入：利用第三方支付金额的数字漏洞如下：
			支付0.019的订单，第三方支付不支持"厘"，就可能支付的金额是0.01（也有可能是0.02）
			这样，当你用第三方支付或者充值了0.01，购买了0.019的订单。
		（3）整数溢出：1元购
			支付金额为2147483648时，第三方充值的金额是int的话，就会溢出变成1元。
		（4）科学计数法
			用于绕过数据的校验，比如输入1e-1 = 0.1,1e-2=0.01,1e+10=10000000000等。
		（5）Price
			前端没有传递后端这个参数的时候，可以尝试传递一个价格参数，看看后端是否会使用这个价格参数。

- 修改支付的状态
- 低价买高价
	+ 续费低价产品，替换订单编号为高价，发现价格没变，支付成功，发的是高价商品订单
- 修改购买数量为负数
- 修改金额为负数
- 重放成功的请求
- 并发数据库锁处理不当

签约漏洞
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 新会员充值优惠
	::
	
		A手机登录，首次签约，优惠支付，跳到支付界面。
		B手机登录，首次签约，优惠支付，跳到支付界面。
		A手机进行支付。
		B手机进行支付。
		存在漏洞的话，那么会进行了两次优惠支付，如对应会员期限为两倍。
- 会员升级
	::
	
		场景类似会员充值优惠利用。
- 优惠卷支付
	::
	
		A手机登录，优惠券支付，跳到支付界面。
		B手机登录，关闭这个订单，重新使用优惠券创建一个订单。
		A手机上把未支付的订单支付完成，关闭的订单可能会进入发货阶段。
- 补充余额
	::
	
		场景类如余额+第三方支付，发起多个第三方支付订单。

业务风控
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 刷优惠券
	+ 并发利用
- 套现

其它
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 订单号相关的漏洞
	+ 生成一个价格极低的订单号
	+ 然后对该订单号进行支付，在输入支付密码时，不要动
	+ 然后修改这个订单为一个价格更高的订单
	+ 然后在支付界面输入支付密码
	+ 如果仅仅对订单支付结果校验，没有对支付金额进行校验，就会产生漏洞
- 钱包相关漏洞：并发

账户
--------------------------------

注册
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 覆盖注册
	+ 邮箱用户名前后空格
	+ 大小写变换
	+ 手机号前后空格
	+ 手机号+86
- 尝试重复用户名
- 注册遍历猜解已有账号

找回密码
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 重置任意用户密码
- 密码重置后新密码在返回包中
- Token验证逻辑在前端
- X-Forwarded-Host处理不正确

修改密码
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 越权修改密码
- 修改密码没有旧密码验证

申诉
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 身份伪造
- 逻辑绕过

oauth csrf账号接管
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- 账号换绑利用1-click欺骗受害者点击从而实现任意账号接管

MFA
--------------------------------
- 可跳一个或多个过身份验证步骤
- 重置密码后自动登录没有2FA
- OAuth登录没有启用2FA
- 2FA可爆破
- 2FA有条件竞争
- 修改返回值绕过
- 激活链接没有启用2FA
- 可通过CSRF禁用2FA

验证码
--------------------------------
- 验证码可重用
- 验证码可预测
- 验证码强度不够
- 验证码无时间限制或者失效时间长
- 验证码无猜测次数限制
- 验证码传递特殊的参数或不传递参数绕过
- 验证码可从返回包中直接获取
- 验证码不刷新或无效
- 验证码数量有限
- 验证码在数据包中返回
- 修改Cookie绕过
- 修改返回包绕过
- 验证码在客户端生成或校验
- 验证码可OCR或使用机器学习识别
- 验证码用于手机短信/邮箱轰炸

Session
--------------------------------
- Session机制
- Session猜测 / 爆破
- Session伪造
- Session泄漏
- Session Fixation

越权
--------------------------------
- 水平越权
	+ 即：攻击者可以访问与他拥有相同权限的用户的资源 
	+ 利用方式：权限类型不变，通过修改数据包中的用户ID等
	+ 利用场景：一般越权漏洞容易出现在权限页面(需要登陆的页面)增，删，改，查的地方。
- 垂直越权
	+ 即：低级别攻击者可以访问高级别用户的资源
	+ 利用方式：权限ID不变，通过修改数据包中的用户权限类型等
	+ 利用场景：一般越权漏洞容易出现在权限页面(需要登陆的页面)增，删，改，查的地方。
- 交叉越权
	- 利用方式：修改用户ID等，修改权限类型等
- 示例
	+ product_id修改为别人的商品ID
	+ user_id修改为别人的用户ID
	+ address_id修改为别人的地址ID

并发
--------------------------------
当多个线程或进程在没有适当同步机制的情况下，同时访问和修改同一份共享数据（如余额、库存、状态标志等），导致最终结果偏离预期。

+ **余额多次使用** :通过并发请求，导致余额多次使用，最终余额为负数。
+ **优惠券多次使用** :通过并发请求，导致优惠券多次使用，最终优惠券数量为负数。
+ **库存多次扣减** :通过并发请求，导致库存多次扣减，最终库存为负数。
+ **状态多次修改** :通过并发请求，导致状态多次修改，最终状态不符合预期。
+ **订单多次提交** :通过并发请求，导致订单多次提交，最终订单数量异常
+ **多次申请退款** :通过并发请求，导致多次申请退款，最终退款金额异常。
+ **多次修改用户信息** :通过并发请求，导致多次修改用户信息，最终用户信息异常。
+ **短信轰炸/邮件轰炸**

遇到有sign或者Token等防护机制时，可以生成多个包，并且尝试阻断多个请求数据包，然后同时发送，观察结果。

条件竞争
--------------------------------
+ 原理：当两个被设计顺序执行的代码部分在不按顺序执行时，发生了竞态条件。

招聘网站
--------------------------------
+ 单个职位只能投递一次：并发投递同一职位，绕过限制
+ 所有职位只能投递一个：并发投递多个职位，绕过限制

二维码
--------------------------------
- 应用场景
	+ 支付
	+ 扫码登录
	+ 扫码关注
	+ 扫码分享
	+ 扫码下载
- URL跳转劫持
	+ 如：?data=xxxxxx&url=http://evil.com
- 接口遍历
	+ 二维码内容可枚举
- xss注入
	+ 二维码内容未过滤直接输出
- 敏感信息泄露
	+ 二维码内容包含敏感信息如token、session，ak，sk等。
- 拒绝服务
	+ 控制二维码图片大小
- 扫码未二次确认
	+ 生成钓鱼二维码
- 强制授权
	+ 观察授权的数据包，查看他人点击授权数据包是否可以自己构造

其他
--------------------------------
- 用户/订单/优惠券等ID生成有规律，可枚举
- 接口无权限、次数限制
- 加密算法实现误用
- 执行顺序
- 敏感信息泄露

参考链接
--------------------------------
- `水平越权漏洞及其解决方案 <http://blog.csdn.net/mylutte/article/details/50819146#10006-weixin-1-52626-6b3bffd01fdde4900130bc5a2751b6d1>`_
- `细说验证码安全 测试思路大梳理 <https://xz.aliyun.com/t/6029>`_
