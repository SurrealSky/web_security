WebSocket漏洞
==================================

漏洞分类
----------------------------------

输入验证与注入类漏洞
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-  **SQL/NoSQL 注入**
   -  WebSocket消息中的参数未经处理直接拼接查询
   -  特别常见于使用JSON格式传输查询条件时

-  **命令注入**
   -  通过消息参数执行系统命令
   -  常见于服务端处理消息时调用系统命令

-  **跨站脚本 (XSS)**
   -  消息内容未过滤直接输出到HTML页面
   -  通过WebSocket传输的恶意脚本被执行

-  **XML/XXE 注入**
   -  通过WebSocket发送恶意XML实体
   -  可能导致文件读取、SSRF等

认证与会话漏洞
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-  **未授权访问**
   -  WebSocket连接无需认证或认证可绕过
   -  敏感功能暴露给未认证用户

-  **会话固定/劫持**
   -  WebSocket会话标识可预测或复用
   -  缺乏会话超时和重新认证机制

-  **认证绕过**
   -  通过修改WebSocket握手请求绕过认证
   -  Token验证逻辑缺陷

配置与传输安全漏洞
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-  **缺少TLS加密**
   -  敏感数据在明文通道传输
   -  WSS协议未强制使用

-  **Origin验证缺失**
   -  未验证WebSocket连接的Origin头
   -  导致CSRF类攻击

-  **消息大小限制缺失**
   -  未限制单个消息大小
   -  可能导致资源耗尽攻击

业务逻辑漏洞
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-  **竞争条件**
   -  并发WebSocket消息处理顺序问题
   -  常见于余额、库存等操作

-  **权限提升**
   -  通过修改消息参数访问未授权功能
   -  水平/垂直越权

-  **重复消息处理**
   -  同一消息多次处理导致业务异常
   -  缺乏幂等性设计

协议实现漏洞
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-  **缓冲区溢出**
   -  处理畸形WebSocket帧时内存越界
   -  特定库或自定义实现常见

-  **拒绝服务 (DoS)**
   -  大量连接耗尽资源
   -  畸形帧导致服务崩溃

-  **跨协议攻击**
   -  利用WebSocket作为跳板攻击后端服务
   -  如SSRF、内网探测等

渗透测试方法
-------------------------------------

信息收集阶段
~~~~~~~~~~~~~~~~
-  **识别WebSocket端点**
   -  使用浏览器开发者工具（Network → WS）
   -  扫描JavaScript文件中的WebSocket URL
   -  常见路径：``/ws``, ``/wss``, ``/socket.io``, ``/socket``

-  **握手请求分析**
   -  捕获HTTP升级请求
   -  检查认证头（Cookie, Token, API Key）
   -  分析自定义头部

-  **协议指纹识别**
   -  确定使用的WebSocket库/框架
   -  如Socket.IO、SockJS、SignalR等

握手阶段测试
~~~~~~~~~~~~~~~~
-  **认证绕过测试**
   -  移除或修改认证头连接
   -  尝试使用其他用户Token连接

-  **Origin验证测试**
   -  修改Origin头为恶意域名
   -  移除Origin头测试

-  **协议版本操纵**
   -  尝试降级到不安全的WebSocket版本
   -  测试非标准握手实现

消息交互测试
~~~~~~~~~~~~~~~~
-  **模糊测试 (Fuzzing)**
   -  发送畸形、超长、特殊字符消息
   -  测试JSON/XML解析器
   -  工具：``wsfuzzer``, ``Burp Suite WebSocket Fuzzer``

-  **业务逻辑测试**
   -  重放消息测试幂等性
   -  并发发送消息测试竞争条件
   -  修改消息顺序测试处理逻辑

-  **注入测试**
   -  SQL注入：在消息参数中插入SQL语句
   -  XSS测试：发送包含``<script>``的消息
   -  命令注入：尝试执行系统命令

会话安全测试
~~~~~~~~~~~~~~~~
-  **会话固定测试**
   -  复用会话标识连接
   -  预测会话标识模式

-  **超时机制测试**
   -  保持长时间空闲连接
   -  断开重连测试会话状态

-  **多用户隔离测试**
   -  尝试访问其他用户频道/房间
   -  订阅未授权数据流

高级攻击测试
~~~~~~~~~~~~~~~~
-  **跨站点 WebSocket 劫持 (CSWSH)**
   -  构造恶意页面发起WebSocket连接
   -  利用用户已认证状态执行操作

-  **WebSocket  smuggling**
   -  利用代理服务器对WebSocket处理差异
   -  构造特殊帧绕过安全控制

-  **拒绝服务测试**
   -  建立大量WebSocket连接
   -  发送超大消息或高频消息

工具使用指南
~~~~~~~~~~~~~~~~
+ ``wsfuzzer``: 专门针对WebSocket的模糊测试工具
+ wsrepl
    - 项目地址： ``https://github.com/doyensec/wsrepl``
    - 命令： ``wsrepl -u URL``

.. note::
   测试前请确保获得合法授权，遵守相关法律法规和测试范围约定。