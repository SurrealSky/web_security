基础
========================================

控制流劫持
----------------------------------------

函数调用约定
----------------------------------------

调用约定
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
参考 :ref:`terminal/window/reverse:函数调用约定`

参数传递
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ 在x86模式下，主要是cdecl(C规范)/stdcall(WinAPI默认)/fastcall函数调用约定。
	- 参数传递使用堆栈进行。
+ x64模式下，调用约定只有fastcall
	- rdi、rsi、rdx、rcx、r8、r9传递前六个参数，然后利用堆栈来传递其他参数。

系统调用
----------------------------------------

方式
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ 通过glibc提供的库函数
+ 使用syscall直接调用
	::
	
		64位系统默认方式：
		函数原型：
		long int syscall (long int sysno, ...)
			1.sysno是系统调用号
			2.… 为剩余可变长的参数
		
		寄存器eax中存放系统调用号，同时系统调用返回值也存放在eax中。
		当系统调用参数小于等于6个时，参数则必须按顺序放到寄存器rdi,rsi,rdx,r10,r8,r9中。
		当系统调用参数大于6个时，全部参数依次存放在一块连续的内存区域，在寄存器ebx中保存指向该区域指针。

+ 通过int指令陷入
	- 软中断指令int 0x80
		::
		
			寄存器eax中存放系统调用号，同时系统调用返回值也存放在eax中
			当系统调用参数小于等于6个时，参数则必须按顺序放到寄存器ebx,ecx,edx,esi,edi,ebp中。
			当系统调用参数大于6个时，全部参数依次存放在一块连续的内存区域，在寄存器ebx中保存指向该区域指针。
	- 在Intel Pentium II又引入了sysenter指令


系统调用表
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

+ 32位系统
	- 位置：/usr/include/asm/unistd_32.h

+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|eax   |系统调用名      |源代码                    |ebx           |ecx                        |edx         |esi |通过堆栈  |
+======+================+==========================+==============+===========================+============+====+==========+
|1     |sys_exit        |kernel/exit.c             |int           |                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|2     |sys_fork        |arch/i386/kernel/process.c|struct pt_regs|                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|3     |sys_read        |fs/read_write.c           |unsigned int  |char *                     |size_t      |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|4     |sys_write       |fs/read_write.c           |unsigned int  |const char *               |size_t      |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|5     |sys_open        |fs/open.c                 |const char *  |int                        |int         |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|6     |sys_close       |fs/open.c                 |unsigned int  |                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|7     |sys_waitpid     |kernel/exit.c             |pid_t         |unsigned int *             |int         |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|8     |sys_creat       |fs/open.c                 |const char *  |int                        |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|9     |sys_link        |fs/namei.c                |const char *  |const char *               |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|10    |sys_unlink      |fs/namei.c                |const char *  |                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|11    |sys_execve      |arch/i386/kernel/process.c|struct pt_regs|                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|12    |sys_chdir       |fs/open.c                 |const char *  |                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|13    |sys_time        |kernel/time.c             |int *         |                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|14    |sys_mknod       |fs/namei.c                |const char *  |int                        |dev_t       |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|15    |sys_chmod       |fs/open.c                 |const char *  |mode_t                     |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|16    |sys_lchown      |fs/open.c                 |const char *  |uid_t                      |gid_t       |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|18    |sys_stat        |fs/stat.c                 |char *        |struct __old_kernel_stat * |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|19    |sys_lseek       |fs/read_write.c           |unsigned int  |off_t                      |unsigned int|    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+
|20    |sys_getpid      |kernel/sched.c            |              |                           |            |    |          |
+------+----------------+--------------------------+--------------+---------------------------+------------+----+----------+

+ 64位系统
	- 位置：/usr/include/asm/unistd_64.h